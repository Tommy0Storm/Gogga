# GOGGA Docker Compose Configuration
# Local development orchestration
# 
# Resource Policy: All containers have memory/CPU limits by default.
# See .docker/resource-policy.yml for anchor definitions.
# Override in docker-compose.override.yml for local adjustments.

# ============================================================
# DEFAULT RESOURCE ANCHORS (reusable across services)
# Optimized for 8GB RAM MacBook Pro - based on actual usage Dec 2025
# ============================================================
x-default-resources: &default-resources
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
      reservations:
        cpus: '0.1'
        memory: 128M

x-node-resources: &node-resources
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 2G
      reservations:
        cpus: '0.25'
        memory: 512M

x-ai-resources: &ai-resources
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 512M

x-minimal-resources: &minimal-resources
  deploy:
    resources:
      limits:
        cpus: '0.1'
        memory: 64M
      reservations:
        cpus: '0.05'
        memory: 32M

# Default environment for Node.js containers
x-node-env: &node-env
  NODE_OPTIONS: --max-old-space-size=1536
  NEXT_TELEMETRY_DISABLED: "1"

# ============================================================
# SERVICES
# ============================================================
services:
  backend:
    build:
      context: ./gogga-backend
      dockerfile: Dockerfile
    container_name: gogga_api
    ports:
      - "8000:8000"
    env_file:
      - ./gogga-backend/.env
    environment:
      - PAYFAST_ENV=sandbox
      # Use gcloud ADC for Vertex AI authentication
      - CLOUDSDK_CONFIG=/root/.config/gcloud
    volumes:
      - ./gogga-backend:/app
      # Mount gcloud config for Vertex AI authentication (Imagen, Veo)
      - ${HOME}/.config/gcloud:/root/.config/gcloud:ro
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    <<: *default-resources

  # GOGGA Frontend - Development Configuration
  # Uses Dockerfile.dev with node:20-alpine for full shell support
  # Uses Docker Compose watch for file sync (NOT bind mounts for node_modules)
  frontend:
    build:
      context: ./gogga-frontend
      dockerfile: Dockerfile.dev
    container_name: gogga_ui
    entrypoint: []
    ports:
      - "3002:3000"
    environment:
      <<: *node-env
      DATABASE_URL: file:/app/prisma/dev.db
      NEXTAUTH_URL: https://192.168.0.130:3000
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret-change-in-production}
      BACKEND_URL: http://backend:8000
      CEPO_URL: http://cepo:8000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-admin-internal-key-dev}
      NEXT_PUBLIC_API_URL: ""
      WATCHPACK_POLLING: "false"
      CHOKIDAR_USEPOLLING: "false"
      FAST_REFRESH: "false"
      NODE_ENV: development
      # EmailJS Outlook Service
      EMAILJS_PUBLIC_KEY: ${EMAILJS_PUBLIC_KEY:-B3ukyx7xd9MrHX2eW}
      EMAILJS_PRIVATE_KEY: ${EMAILJS_PRIVATE_KEY:-rh87uE_EH0onM2qaB41V4}
      EMAILJS_SERVICE_ID: ${EMAILJS_SERVICE_ID:-service_53ldd2p}
      EMAILJS_TEMPLATE_ID: ${EMAILJS_TEMPLATE_ID:-template_hhsckmm}
    volumes:
      - ./gogga-frontend:/app
      - ./gogga-frontend/prisma:/app/prisma
      - ./gogga-frontend/certs:/app/certs:ro
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
    depends_on:
      - backend
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Docker Compose watch for development hot reload
    # Run with: docker compose up --watch frontend
    develop:
      watch:
        # Sync source files (triggers Next.js hot reload)
        - action: sync
          path: ./gogga-frontend/src
          target: /app/src
          ignore:
            - "**/*.test.*"
            - "**/__tests__/**"
        # Sync public assets
        - action: sync
          path: ./gogga-frontend/public
          target: /app/public
        # Rebuild on package.json change
        - action: rebuild
          path: ./gogga-frontend/package.json
        # Rebuild on config changes
        - action: rebuild
          path: ./gogga-frontend/next.config.js
        - action: rebuild
          path: ./gogga-frontend/tailwind.config.js
    <<: *node-resources

  # Network Proxy - Workaround for Next.js 16 network access bug
  # Forwards external HTTPS connections on port 3001 to frontend:3000 (HTTPS)
  proxy:
    build:
      context: ./gogga-proxy
      dockerfile: Dockerfile
    container_name: gogga_proxy
    ports:
      - "3001:3001"
    environment:
      TARGET_HOST: frontend
      USE_TLS: "true"
      SERVE_TLS: "true"
      TLS_KEY: /app/certs/key.pem
      TLS_CERT: /app/certs/cert.pem
    volumes:
      - ./gogga-frontend/certs:/app/certs:ro
      - ./gogga-proxy/proxy.js:/app/proxy.js:ro
    depends_on:
      - frontend
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    <<: *minimal-resources

  # GOGGA Admin Panel - Separate container for administration
  admin:
    build:
      context: ./gogga-admin
      dockerfile: Dockerfile.dev
    container_name: gogga_admin
    ports:
      - "3100:3100"
    environment:
      <<: *node-env
      NODE_OPTIONS: --max-old-space-size=768
      DATABASE_URL: file:/app/prisma/dev.db
      BACKEND_URL: http://backend:8000
      NEXT_PUBLIC_BACKEND_URL: http://192.168.0.130:8000
      FRONTEND_URL: http://frontend:3000
      CEPO_URL: http://cepo:8000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-admin-internal-key-dev}
      ADMIN_EMAILS: admin@vcb-ai.online
      PAYFAST_ENV: sandbox
    volumes:
      - ./gogga-admin:/app
      - ./gogga-frontend/prisma:/app/prisma
      - admin_node_modules:/app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - backend
      - frontend
      - cepo
    networks:
      - gogga_network
    restart: unless-stopped
    <<: *node-resources

  # CePO Sidecar - OptiLLM with Cerebras Planning and Optimization
  # Routes JIVE/JIGGA requests through enhanced reasoning pipeline
  # Provides +10-15% accuracy improvement on reasoning tasks
  # Uses ReRead + CoT Reflection (Cerebras-compatible, n=1 only)
  cepo:
    build:
      context: ./gogga-cepo
      dockerfile: Dockerfile
    container_name: gogga_cepo
    ports:
      - "8080:8000"
    env_file:
      - ./gogga-backend/.env
    environment:
      # Use re2&cot_reflection - ReRead + CoT with Reflection
      # Cerebras-compatible: no reasoning_effort, no n>1
      # re2: processes query twice for better reasoning
      # cot_reflection: structured <thinking> <reflection> <output>
      OPTILLM_APPROACH: "re2&cot_reflection"
      OPTILLM_PORT: "8000"
      # Model for base completions
      OPTILLM_MODEL: "qwen-3-32b"
      # Enhanced logging for debugging
      OPTILLM_LOG_LEVEL: "DEBUG"
      PYTHONUNBUFFERED: "1"
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    <<: *ai-resources

networks:
  gogga_network:
    driver: bridge

volumes:
  # Admin node_modules volume - needed for native module rebuild on startup
  admin_node_modules:
  # Frontend volumes - prevent node_modules corruption
  frontend_node_modules:
  frontend_next:
