# GOGGA Docker Compose Configuration
# Local development orchestration
# 
# Resource Policy: All containers have memory/CPU limits by default.
# See .docker/resource-policy.yml for anchor definitions.
# Override in docker-compose.override.yml for local adjustments.

# ============================================================
# DEFAULT RESOURCE ANCHORS (reusable across services)
# ============================================================
x-default-resources: &default-resources
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
      reservations:
        cpus: '0.1'
        memory: 128M

x-node-resources: &node-resources
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 256M

x-ai-resources: &ai-resources
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 512M

x-minimal-resources: &minimal-resources
  deploy:
    resources:
      limits:
        cpus: '0.1'
        memory: 64M
      reservations:
        cpus: '0.05'
        memory: 32M

# Default environment for Node.js containers
x-node-env: &node-env
  NODE_OPTIONS: --max-old-space-size=256
  NEXT_TELEMETRY_DISABLED: "1"

# ============================================================
# SERVICES
# ============================================================
services:
  backend:
    build:
      context: ./gogga-backend
      dockerfile: Dockerfile
    container_name: gogga_api
    ports:
      - "8000:8000"
    env_file:
      - ./gogga-backend/.env
    environment:
      - PAYFAST_ENV=sandbox
    volumes:
      - ./gogga-backend:/app
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    <<: *default-resources

  frontend:
    build:
      context: ./gogga-frontend
      dockerfile: Dockerfile
    container_name: gogga_ui
    ports:
      - "3000:3000"
    environment:
      <<: *node-env
      NEXT_PUBLIC_API_URL: ""
    command: sh -c "npm install && ./node_modules/.bin/prisma generate && npm run dev:http"
    volumes:
      - ./gogga-frontend:/app
      - ./gogga-frontend/certs:/app/certs
      - frontend_node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - gogga_network
    restart: unless-stopped
    <<: *node-resources

  # Network Proxy - Workaround for Next.js 16 network access bug
  # Forwards external connections on port 3001 to frontend:3000
  proxy:
    build:
      context: ./gogga-proxy
      dockerfile: Dockerfile
    container_name: gogga_proxy
    ports:
      - "3001:3001"
    depends_on:
      - frontend
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    <<: *minimal-resources

  # GOGGA Admin Panel - Separate container for administration
  admin:
    build:
      context: ./gogga-admin
      dockerfile: Dockerfile.dev
    container_name: gogga_admin
    ports:
      - "3100:3100"
    environment:
      <<: *node-env
      NODE_OPTIONS: --max-old-space-size=192
      DATABASE_URL: file:/app/prisma/dev.db
      BACKEND_URL: http://backend:8000
      FRONTEND_URL: http://frontend:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-admin-internal-key-dev}
      ADMIN_EMAILS: admin@vcb-ai.online
      PAYFAST_ENV: sandbox
    volumes:
      - ./gogga-admin:/app
      - ./gogga-frontend/prisma:/app/prisma
      - admin_node_modules:/app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - backend
      - frontend
    networks:
      - gogga_network
    restart: unless-stopped
    <<: *default-resources

  # CePO Sidecar - OptiLLM with Cerebras Planning and Optimization
  # Routes JIVE/JIGGA requests through 4-step CePO pipeline + Best of N selection
  # Provides +10-20% accuracy improvement on reasoning tasks
  cepo:
    build:
      context: ./gogga-cepo
      dockerfile: Dockerfile
    container_name: gogga_cepo
    ports:
      - "8080:8080"
    env_file:
      - ./gogga-backend/.env
    environment:
      # CePO pipeline configuration
      OPTILLM_APPROACH: "cepo"
      CEPO_BESTOFN_N: "3"
      CEPO_PLANNING_N: "3"
      CEPO_PLANNING_M: "6"
      CEPO_BESTOFN_RATING_TYPE: "absolute"
      OPTILLM_CEPO_USE_REASONING_FALLBACK: "false"  # Cerebras doesn't support reasoning_effort
      # Planning temperature gradient (0.55 → 0.25 → 0.1 → 0.0)
      CEPO_TEMP_INITIAL_PLAN: "0.55"
      CEPO_TEMP_INITIAL_SOLUTION: "0.25"
      CEPO_TEMP_REFINED_PLAN: "0.1"
      CEPO_TEMP_FINAL_SOLUTION: "0.0"
    networks:
      - gogga_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    <<: *ai-resources

networks:
  gogga_network:
    driver: bridge

volumes:
  frontend_node_modules:
  admin_node_modules:
