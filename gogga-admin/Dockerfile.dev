# GOGGA Admin Panel - Development Dockerfile
FROM node:20-alpine

WORKDIR /app

# Install Docker CLI, curl, OpenSSL for Prisma, and build tools for native modules (better-sqlite3)
RUN apk add --no-cache docker-cli curl openssl openssl-dev python3 make g++ gcc libc-dev

# Install pnpm and configure to allow build scripts
RUN corepack enable pnpm && \
    pnpm config set enable-pre-post-scripts true

# Copy package files
COPY package.json pnpm-lock.yaml* ./

# Install dependencies with build scripts allowed for native modules
RUN pnpm i --config.allow-scripts=better-sqlite3 && \
    cd node_modules/.pnpm/better-sqlite3@*/node_modules/better-sqlite3 && \
    npm run build-release

# Copy prisma schema
COPY prisma ./prisma

# Generate Prisma client
RUN npx prisma generate

# Copy SQLite tools (for database management)
COPY tools ./tools
RUN chmod +x ./tools/*

# Copy rest of application
COPY . .

EXPOSE 3100

# Run prisma generate on startup to handle volume mount overwriting node_modules
# CI=true prevents pnpm from prompting for TTY
# Rebuild better-sqlite3 native module since volume mount overwrites it
CMD ["sh", "-c", "CI=true pnpm i --config.allow-scripts=better-sqlite3 && cd node_modules/.pnpm/better-sqlite3@*/node_modules/better-sqlite3 && npm run build-release 2>/dev/null || true && cd /app && npx prisma generate && pnpm dev"]
