# =============================================================================
# GOGGA Docker Compose Override - Distributed Infrastructure
# =============================================================================
# This override optimizes for the two-server distributed setup:
# - Primary (192.168.0.130): Frontend, Backend, Admin, Proxy
# - Worker (192.168.0.198): CePO, cAdvisor, heavy AI workloads
#
# Changes from base docker-compose.yml:
# 1. Disables local CePO (uses worker's CePO at 192.168.0.198:8080)
# 2. Increases Node.js memory limits for frontend/admin
# 3. Points services to worker's CePO endpoint
# =============================================================================

services:
  # ============================================================
  # FRONTEND - Increased memory for Next.js 16 + RxDB
  # Optimized Dec 2025: +1G from admin (5G total)
  # ============================================================
  frontend:
    entrypoint: []
    user: root
    env_file:
      - ./gogga-frontend/.env.local
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 5G
        reservations:
          cpus: '0.5'
          memory: 2G
    # OOM protection: keep frontend alive as priority service
    oom_score_adj: -500
    environment:
      # V8 heap: ~4.5GB (leave room for native memory)
      NODE_OPTIONS: --max-old-space-size=4608
      # Point to worker's CePO
      CEPO_URL: http://192.168.0.198:8080
      # Magic-link base URL (what users click in email) - HTTPS for GoggaTalk
      NEXTAUTH_URL: https://192.168.0.130:3002
      NEXT_PUBLIC_BASE_URL: https://192.168.0.130:3002
    # Run HTTPS Turbopack dev server (default in Next.js 16, more memory efficient)
    command: sh -c "npm install && ./node_modules/.bin/prisma generate && ./node_modules/.bin/next dev -H 0.0.0.0 -p 3000 --experimental-https --experimental-https-key ./certs/key.pem --experimental-https-cert ./certs/cert.pem"
    # Keep source mounted, but put write-heavy outputs in named volumes
    volumes:
      - ./gogga-frontend:/app
      - ./gogga-frontend/certs:/app/certs
      - frontend_node_modules:/app/node_modules
      - frontend_next_cache:/app/.next

  # ============================================================
  # BACKEND - Standard resources, points to worker CePO
  # ============================================================
  backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    environment:
      # Use worker's CePO for AI processing
      CEPO_URL: http://192.168.0.198:8080
      # Frontend URL for usage logging (Docker network - frontend container)
      FRONTEND_URL: https://frontend:3000
    # Mount certs for HTTPS
    volumes:
      - ./gogga-backend:/app
      - ./gogga-frontend/certs:/app/certs:ro
    # Run with HTTPS to match frontend
    command: python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 --ssl-keyfile /app/certs/key.pem --ssl-certfile /app/certs/cert.pem

  # ============================================================
  # ADMIN - Reduced memory (dashboard doesn't need much)
  # Optimized Dec 2025: -1G transferred to frontend (1.5G total)
  # ============================================================
  admin:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.5G
        reservations:
          cpus: '0.25'
          memory: 512M
    environment:
      # V8 heap: ~1.2GB
      NODE_OPTIONS: --max-old-space-size=1228
      # Point to worker's CePO
      CEPO_URL: http://192.168.0.198:8080

  # ============================================================
  # PROXY - Minimal resources (just SSL termination)
  # ============================================================
  proxy:
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    environment:
      TARGET_HOST: frontend

  # ============================================================
  # CEPO - Lightweight stub pointing to worker
  # ============================================================
  # Keep container defined for dependency resolution but make it
  # a lightweight proxy or just disable building
  cepo:
    # Override to use a simple healthcheck-only container
    # The actual CePO runs on worker at 192.168.0.198:8080
    image: alpine:latest
    build: !reset null
    container_name: gogga_cepo_stub
    command: ["sh", "-c", "while true; do sleep 3600; done"]
    ports: !reset []
    env_file: !reset []
    environment: {}
    volumes: !reset []
    deploy:
      resources:
        limits:
          cpus: '0.01'
          memory: 16M
        reservations:
          cpus: '0.01'
          memory: 8M
    healthcheck:
      test: ["CMD", "true"]
      interval: 300s
      timeout: 5s
      retries: 1
    restart: unless-stopped

volumes:
  frontend_next_cache:

# =============================================================================
# MEMORY ALLOCATION SUMMARY (Primary Server - 7.7GB total)
# Optimized Dec 2025: Reallocated 1G from Admin to Frontend
# =============================================================================
# Service      | Limit  | Reserved | NODE_OPTIONS         | Purpose
# -------------|--------|----------|----------------------|------------------
# Frontend     | 5.0GB  | 2.0GB    | --max-old-space=4608 | Next.js 16 + RxDB
# Admin        | 1.5GB  | 512MB    | --max-old-space=1228 | Dashboard (light)
# Backend      | 512MB  | 256MB    | N/A (Python)         | FastAPI
# Proxy        | 128MB  | 32MB     | N/A                  | SSL termination
# CePO stub    | 16MB   | 8MB      | N/A                  | Placeholder
# -------------|--------|----------|----------------------|------------------
# TOTAL LIMITS | 7.2GB  | 2.8GB    |                      | Max headroom
# =============================================================================
#
# Worker Server (192.168.0.198) runs:
# - CePO: 4GB limit (AI processing with OptiLLM)
# - cAdvisor: 256MB (monitoring)
# =============================================================================
