# =============================================================================
# GOGGA Docker Compose Override - Distributed Infrastructure
# =============================================================================
# This override optimizes for the two-server distributed setup:
# - Primary (192.168.0.130): Frontend, Backend, Admin, Proxy
# - Worker (192.168.0.198): CePO, cAdvisor, heavy AI workloads
#
# Changes from base docker-compose.yml:
# 1. Disables local CePO (uses worker's CePO at 192.168.0.198:8080)
# 2. Increases Node.js memory limits for frontend/admin
# 3. Points services to worker's CePO endpoint
# =============================================================================

services:
  # ============================================================
  # FRONTEND - Increased memory for Next.js 16 + RxDB
  # ============================================================
  frontend:
    entrypoint: []
    user: root
    env_file:
      - ./gogga-frontend/.env.local
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 1G
    environment:
      NODE_OPTIONS: --max-old-space-size=2560
      # Point to worker's CePO
      CEPO_URL: http://192.168.0.198:8080
      # Magic-link base URL (what users click in email) - HTTPS for GoggaTalk
      NEXTAUTH_URL: https://192.168.0.130:3002
      NEXT_PUBLIC_BASE_URL: https://192.168.0.130:3002
    # Run HTTPS webpack dev server (required for GoggaTalk MediaRecorder API)
    command: sh -c "npm install && ./node_modules/.bin/prisma generate && ./node_modules/.bin/next dev -H 0.0.0.0 -p 3000 --webpack --experimental-https --experimental-https-key ./certs/key.pem --experimental-https-cert ./certs/cert.pem"
    # Keep source mounted, but put write-heavy outputs in named volumes
    volumes:
      - ./gogga-frontend:/app
      - ./gogga-frontend/certs:/app/certs
      - frontend_node_modules:/app/node_modules
      - frontend_next_cache:/app/.next

  # ============================================================
  # BACKEND - Standard resources, points to worker CePO
  # ============================================================
  backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    environment:
      # Use worker's CePO for AI processing
      CEPO_URL: http://192.168.0.198:8080
    # Mount certs for HTTPS
    volumes:
      - ./gogga-backend:/app
      - ./gogga-frontend/certs:/app/certs:ro
    # Run with HTTPS to match frontend
    command: python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 --ssl-keyfile /app/certs/key.pem --ssl-certfile /app/certs/cert.pem

  # ============================================================
  # ADMIN - Increased memory for dashboard operations
  # ============================================================
  admin:
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2.5G
        reservations:
          cpus: '0.25'
          memory: 768M
    environment:
      NODE_OPTIONS: --max-old-space-size=2048
      # Point to worker's CePO
      CEPO_URL: http://192.168.0.198:8080

  # ============================================================
  # PROXY - Minimal resources (just SSL termination)
  # ============================================================
  proxy:
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    environment:
      TARGET_HOST: frontend

  # ============================================================
  # CEPO - Lightweight stub pointing to worker
  # ============================================================
  # Keep container defined for dependency resolution but make it
  # a lightweight proxy or just disable building
  cepo:
    # Override to use a simple healthcheck-only container
    # The actual CePO runs on worker at 192.168.0.198:8080
    image: alpine:latest
    build: !reset null
    container_name: gogga_cepo_stub
    command: ["sh", "-c", "while true; do sleep 3600; done"]
    ports: !reset []
    env_file: !reset []
    environment: {}
    volumes: !reset []
    deploy:
      resources:
        limits:
          cpus: '0.01'
          memory: 16M
        reservations:
          cpus: '0.01'
          memory: 8M
    healthcheck:
      test: ["CMD", "true"]
      interval: 300s
      timeout: 5s
      retries: 1
    restart: unless-stopped

volumes:
  frontend_next_cache:

# =============================================================================
# MEMORY ALLOCATION SUMMARY (Primary Server - 7.7GB total)
# =============================================================================
# Service      | Limit  | Reserved | Purpose
# -------------|--------|----------|----------------------------------
# Frontend     | 3.0GB  | 1.0GB    | Next.js 16 + RxDB + React 19
# Admin        | 2.5GB  | 768MB    | Dashboard + Docker management
# Backend      | 512MB  | 256MB    | FastAPI (lightweight)
# Proxy        | 128MB  | 32MB     | SSL termination only
# -------------|--------|----------|----------------------------------
# TOTAL LIMITS | 6.1GB  | 2.0GB    | Leaves ~1.5GB for system/buffer
# =============================================================================
#
# Worker Server (192.168.0.198) runs:
# - CePO: 4GB limit (AI processing with OptiLLM)
# - cAdvisor: 256MB (monitoring)
# =============================================================================
