generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model AdminLog {
  id         String   @id @default(cuid())
  adminEmail String
  action     String
  targetUser String?
  targetId   String?
  meta       String?
  ip         String?
  createdAt  DateTime @default(now())

  @@index([targetUser])
  @@index([action])
  @@index([adminEmail])
}

model AuthLog {
  id        String   @id @default(cuid())
  email     String?
  action    String
  ip        String?
  meta      String?
  createdAt DateTime @default(now())
}

model CreditPurchase {
  id          String    @id @default(cuid())
  userId      String
  packSize    String
  credits     Int
  pfPaymentId String?
  status      String
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
}

model DebugSubmission {
  id          String    @id @default(cuid())
  userId      String?
  reason      String
  consoleLogs String
  networkLogs String?
  errorStack  String?
  userAgent   String
  url         String
  screenSize  String?
  status      String    @default("pending")
  adminNotes  String?
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime  @default(now())
  User        User?     @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model LoginToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProcessedPayment {
  id          String   @id @default(cuid())
  pfPaymentId String   @unique
  type        String
  amount      Int
  userId      String
  processedAt DateTime @default(now())
}

model RecurringSchedule {
  id            String    @id @default(cuid())
  userId        String
  tier          String
  amount        Int
  token         String
  frequency     String    @default("monthly")
  nextChargeAt  DateTime
  lastChargedAt DateTime?
  chargeCount   Int       @default(0)
  maxCharges    Int       @default(12)
  status        String    @default("active")
  failedCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([nextChargeAt])
  @@index([userId])
}

model Subscription {
  id              String    @id @default(cuid())
  userId          String    @unique
  tier            String
  status          String
  payfastToken    String?
  credits         Int       @default(0)
  creditsUsed     Int       @default(0)
  monthlyCredits  Int       @default(0)
  imagesUsed      Int       @default(0)
  imagesLimit     Int       @default(50)
  startedAt       DateTime?
  nextBilling     DateTime?
  lastReset       DateTime?
  paymentFailedAt DateTime?
  retryCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  User            User      @relation(fields: [userId], references: [id])
}

model SubscriptionEvent {
  id             String   @id @default(cuid())
  subscriptionId String
  userId         String
  event          String
  fromTier       String?
  toTier         String?
  fromStatus     String?
  toStatus       String?
  actor          String?
  meta           String?
  createdAt      DateTime @default(now())

  @@index([event])
  @@index([userId])
  @@index([subscriptionId])
}

model Usage {
  id               String   @id @default(cuid())
  userId           String
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  costCents        Int      @default(0)
  model            String
  provider         String
  endpoint         String
  tier             String
  conversationId   String?
  requestId        String?
  durationMs       Int?
  createdAt        DateTime @default(now())
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([endpoint])
  @@index([model])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId])
}

model UsageSummary {
  id               String   @id @default(cuid())
  userId           String
  year             Int
  month            Int
  totalTokens      Int      @default(0)
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalCostCents   Int      @default(0)
  chatRequests     Int      @default(0)
  enhanceRequests  Int      @default(0)
  imageRequests    Int      @default(0)
  imagesUsed       Int      @default(0)
  updatedAt        DateTime @updatedAt
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([year, month])
  @@index([userId])
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  isAdmin         Boolean           @default(false)
  isServiceAdmin  Boolean           @default(false)
  isTester        Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  DebugSubmission DebugSubmission[]
  Subscription    Subscription?
  Usage           Usage[]
  UsageSummary    UsageSummary[]
}

model Voucher {
  id         String    @id @default(cuid())
  code       String    @unique
  type       String
  value      Int       @default(0)
  createdBy  String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  voided     Boolean   @default(false)
  voidedAt   DateTime?
  voidedBy   String?
  voidReason String?
  redeemed   Boolean   @default(false)
  redeemedAt DateTime?
  redeemedBy String?
  userId     String?
  batchId    String?

  @@index([createdBy])
  @@index([batchId])
  @@index([type])
  @@index([code])
}

model VoucherLog {
  id        String   @id @default(cuid())
  voucherId String
  action    String
  actor     String
  meta      String?
  createdAt DateTime @default(now())

  @@index([actor])
  @@index([voucherId])
}
