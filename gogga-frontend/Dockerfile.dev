# GOGGA Frontend Development Dockerfile
# Uses node:20-alpine for full shell support and native module compilation
FROM node:20-alpine

WORKDIR /app

# Install build dependencies for native modules (better-sqlite3, sharp, etc.)
# Install pnpm globally and wget for healthchecks
RUN apk update && apk add --no-cache python3 make g++ wget && \
    corepack enable && corepack prepare pnpm@latest --activate

# Copy package files and .npmrc for build config
COPY package.json pnpm-lock.yaml .npmrc ./

# Install dependencies and force rebuild native modules
RUN pnpm install --frozen-lockfile && \
    cd node_modules/better-sqlite3 && npx node-gyp rebuild || true && \
    cd /app && pnpm rebuild better-sqlite3 || true

# Set backend URL for Docker networking
ENV BACKEND_URL=http://backend:8000
ENV NODE_ENV=development

# Expose port
EXPOSE 3000

# Start development server with HTTPS
# Generate Prisma client first, then start Next.js on 0.0.0.0 (all interfaces)
CMD ["sh", "-c", "pnpm prisma generate && next dev -H 0.0.0.0 -p 3000"]
